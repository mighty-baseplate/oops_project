<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Answers - Online Exam System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .question-card {
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .question-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .correct-answer {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        .wrong-answer {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .your-answer {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .correct-answer-box {
            background-color: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .score-badge {
            font-size: 1.2rem;
            padding: 10px 20px;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-eye-fill"></i> Review Your Answers
            </span>
            <div class="d-flex">
                <span class="text-white me-3">
                    <i class="bi bi-person-circle"></i> <span th:text="${student.name}"></span>
                </span>
                <a th:href="@{/student/dashboard}" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-house-fill"></i> Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Exam Header -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="mb-2">
                            <i class="bi bi-journal-text"></i> 
                            <span th:text="${exam.title}">Exam Title</span>
                        </h3>
                        <p class="mb-0">
                            <span class="badge bg-info me-2" th:text="${exam.type.displayName}">MCQ</span>
                            <span class="text-muted">Total Questions: </span>
                            <strong th:text="${questions.size()}">10</strong>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div>
                            <span class="badge score-badge" 
                                  th:classappend="${(submission.score * 100.0 / exam.totalMarks) >= 60} ? 'bg-success' : 'bg-danger'">
                                Score: <span th:text="${submission.score} + ' / ' + ${exam.totalMarks}">85/100</span>
                            </span>
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-secondary">
                                <span th:text="${#numbers.formatDecimal((submission.score * 100.0 / exam.totalMarks), 1, 1)} + '%'">85%</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-info-circle"></i> Legend</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div style="width: 20px; height: 20px; background-color: #d4edda; border: 1px solid #28a745; margin-right: 10px;"></div>
                            <span>Correct Answer</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div style="width: 20px; height: 20px; background-color: #f8d7da; border: 1px solid #dc3545; margin-right: 10px;"></div>
                            <span>Wrong Answer</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div style="width: 20px; height: 20px; background-color: #fff3cd; border: 1px solid #ffc107; margin-right: 10px;"></div>
                            <span>Your Answer</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Questions Review -->
        <div class="row">
            <div class="col-12">
                <div th:each="question, iterStat : ${questions}" class="card question-card" 
                     th:classappend="${studentAnswers[iterStat.index] != null && studentAnswers[iterStat.index].equalsIgnoreCase(question.correctAnswer)} ? 'correct-answer' : 'wrong-answer'">
                    <div class="card-body">
                        <!-- Question Number and Text -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5>
                                <span class="badge bg-primary me-2" th:text="'Q' + ${iterStat.index + 1}">Q1</span>
                                <span th:text="${question.text}">Question text goes here?</span>
                            </h5>
                            <span th:if="${studentAnswers[iterStat.index] != null && studentAnswers[iterStat.index].equalsIgnoreCase(question.correctAnswer)}" 
                                  class="badge bg-success">
                                <i class="bi bi-check-circle-fill"></i> Correct
                            </span>
                            <span th:if="${studentAnswers[iterStat.index] == null || !studentAnswers[iterStat.index].equalsIgnoreCase(question.correctAnswer)}" 
                                  class="badge bg-danger">
                                <i class="bi bi-x-circle-fill"></i> Wrong
                            </span>
                        </div>

                        <!-- MCQ Options (if available) -->
                        <div th:if="${question.optionsJson != null && !question.optionsJson.isEmpty()}">
                            <div class="ms-4">
                                <p class="mb-2"><strong>Options:</strong></p>
                                <ul class="list-unstyled">
                                    <li th:each="option, optIterStat : ${question.optionsArray}" class="mb-1">
                                        <span th:text="${option}">Option A</span>
                                        <span th:if="${option.equals(question.correctAnswer)}" class="badge bg-success ms-2">
                                            <i class="bi bi-check"></i> Correct Answer
                                        </span>
                                        <span th:if="${studentAnswers[iterStat.index] != null && option.equals(studentAnswers[iterStat.index]) && !option.equals(question.correctAnswer)}" 
                                              class="badge bg-danger ms-2">
                                            <i class="bi bi-x"></i> Your Wrong Choice
                                        </span>
                                        <span th:if="${studentAnswers[iterStat.index] != null && option.equals(studentAnswers[iterStat.index]) && option.equals(question.correctAnswer)}" 
                                              class="badge bg-success ms-2">
                                            <i class="bi bi-check"></i> Your Correct Choice
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Your Answer -->
                        <div class="your-answer">
                            <strong><i class="bi bi-pencil-fill"></i> Your Answer:</strong>
                            <span th:if="${studentAnswers[iterStat.index] != null && !studentAnswers[iterStat.index].isEmpty()}" 
                                  th:text="${studentAnswers[iterStat.index]}">Student's answer</span>
                            <span th:if="${studentAnswers[iterStat.index] == null || studentAnswers[iterStat.index].isEmpty()}" 
                                  class="text-muted fst-italic">Not answered</span>
                        </div>

                        <!-- Correct Answer -->
                        <div class="correct-answer-box mt-2">
                            <strong><i class="bi bi-check-circle-fill"></i> Correct Answer:</strong>
                            <span th:text="${question.correctAnswer}">Correct answer</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="card mt-4 mb-4">
            <div class="card-body">
                <h5 class="mb-3"><i class="bi bi-graph-up"></i> Performance Summary</h5>
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="p-3">
                            <h4 class="text-primary" th:text="${questions.size()}">10</h4>
                            <p class="mb-0">Total Questions</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <h4 class="text-success" th:text="${submission.score / 10}">8</h4>
                            <p class="mb-0">Correct Answers</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <h4 class="text-danger" th:text="${questions.size() - (submission.score / 10)}">2</h4>
                            <p class="mb-0">Wrong Answers</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <h4 th:classappend="${(submission.score * 100.0 / exam.totalMarks) >= 60} ? 'text-success' : 'text-danger'" 
                                th:text="${#numbers.formatDecimal((submission.score * 100.0 / exam.totalMarks), 1, 1)} + '%'">80%</h4>
                            <p class="mb-0">Percentage</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mb-4">
            <a th:href="@{/student/exam/{id}(id=${exam.id})}" class="btn btn-primary btn-lg me-2">
                <i class="bi bi-arrow-repeat"></i> Retake This Exam
            </a>
            <a th:href="@{/student/dashboard}" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-house-fill"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Scroll to first wrong answer
        window.addEventListener('load', function() {
            const firstWrong = document.querySelector('.wrong-answer');
            if (firstWrong) {
                firstWrong.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    </script>
</body>
</html>
